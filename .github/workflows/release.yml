name: release

on:
  push:
    tags:
      - v*.*.*

env:
  PROVIDER: webflow
  PULUMI_LOCAL_NUGET: ${{ github.workspace }}/nuget
  GOVERSION: "1.21.x"
  NODEVERSION: "20.x"
  PYTHONVERSION: "3.11.8"
  DOTNETVERSION: "8.0.x"
  JAVAVERSION: "11"

jobs:
  prerequisites:
    runs-on: ubuntu-latest
    name: prerequisites
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          lfs: true

      - id: version
        name: Set Provider Version
        uses: pulumi/provider-version-action@v1
        with:
          set-env: PROVIDER_VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Tools
        uses: ./.github/actions/setup-tools
        with:
          cache: "true"
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build codegen binaries
        run: make codegen

      - name: Build Schema
        run: make generate_schema

      - name: Build Provider
        run: make provider

      - name: Check worktree clean
        uses: pulumi/git-status-check-action@v1
        with:
          allowed-changes: |
            sdk/**/pulumi-plugin.json
            sdk/dotnet/*.*.csproj
            sdk/dotnet/version.txt
            sdk/go/**/pulumiUtilities.go
            sdk/nodejs/package.json
            sdk/python/pyproject.toml
            sdk/java/build.gradle

      - name: Tar provider binaries
        run: tar -zcf ${{ github.workspace }}/bin/provider.tar.gz -C ${{ github.workspace }}/bin/ pulumi-resource-${{ env.PROVIDER }} pulumi-gen-${{ env.PROVIDER }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pulumi-${{ env.PROVIDER }}-provider.tar.gz
          path: ${{ github.workspace }}/bin/provider.tar.gz

      - name: Test Provider Library
        run: make test_provider
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_sdks:
    needs: prerequisites
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        language:
          - nodejs
          - python
          - dotnet
          - go
          - java
    name: build_sdks
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          lfs: true

      - id: version
        name: Set Provider Version
        uses: pulumi/provider-version-action@v1
        with:
          set-env: PROVIDER_VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Tools
        uses: ./.github/actions/setup-tools
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Provider Binary
        uses: ./.github/actions/download-provider

      - name: Generate SDK
        run: make generate_${{ matrix.language }}

      - name: Build SDK
        run: make build_${{ matrix.language }}

      - name: Check worktree clean
        uses: pulumi/git-status-check-action@v1
        with:
          allowed-changes: |
            sdk/**/pulumi-plugin.json
            sdk/dotnet/*.*.csproj
            sdk/dotnet/version.txt
            sdk/go/**/pulumiUtilities.go
            sdk/nodejs/package.json
            sdk/python/pyproject.toml
            sdk/java/build.gradle

      - name: Tar SDK folder
        run: tar -zcf sdk/${{ matrix.language }}.tar.gz -C sdk/${{ matrix.language }} .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.language }}-sdk.tar.gz
          path: ${{ github.workspace }}/sdk/${{ matrix.language }}.tar.gz

  publish:
    runs-on: ubuntu-latest
    needs: [build_sdks]
    name: publish
    permissions:
      contents: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          lfs: true

      - id: version
        name: Set Provider Version
        uses: pulumi/provider-version-action@v1
        with:
          set-env: PROVIDER_VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Tools
        uses: ./.github/actions/setup-tools
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Syft (for SBOM generation)
        uses: anchore/sbom-action/download-syft@v0

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v5
        env:
          GORELEASER_CURRENT_TAG: v${{ steps.version.outputs.version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: -p 3 release --clean --timeout 60m0s
          version: latest

  publish_sdks:
    runs-on: ubuntu-latest
    needs: publish
    name: publish_sdks
    permissions:
      id-token: write  # Required for PyPI Trusted Publishing and npm provenance
      contents: read
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          lfs: true

      - id: version
        name: Set Provider Version
        uses: pulumi/provider-version-action@v1
        with:
          set-env: PROVIDER_VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Tools
        uses: ./.github/actions/setup-tools
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download python SDK
        uses: actions/download-artifact@v4
        with:
          name: python-sdk.tar.gz
          path: ${{ github.workspace }}/sdk/

      - name: Uncompress python SDK
        run: tar -zxf ${{ github.workspace }}/sdk/python.tar.gz -C ${{ github.workspace }}/sdk/python

      - name: Download dotnet SDK
        uses: actions/download-artifact@v4
        with:
          name: dotnet-sdk.tar.gz
          path: ${{ github.workspace }}/sdk/

      - name: Uncompress dotnet SDK
        run: tar -zxf ${{ github.workspace }}/sdk/dotnet.tar.gz -C ${{ github.workspace }}/sdk/dotnet

      - name: Download nodejs SDK
        uses: actions/download-artifact@v4
        with:
          name: nodejs-sdk.tar.gz
          path: ${{ github.workspace }}/sdk/

      - name: Uncompress nodejs SDK
        run: tar -zxf ${{ github.workspace }}/sdk/nodejs.tar.gz -C ${{ github.workspace }}/sdk/nodejs

      # Publish Node.js SDK to npm using Trusted Publishing (OIDC)
      # Requires: Trusted Publisher configured on npmjs.com + id-token: write permission
      # See: https://docs.npmjs.com/trusted-publishers/
      - name: Setup npm Trusted Publishing
        uses: azu/setup-npm-trusted-publish@v1

      - name: Publish Node.js SDK
        run: |
          cd sdk/nodejs
          # Determine npm tag based on version (prerelease versions need explicit tag)
          if [[ "$PROVIDER_VERSION" == *"-alpha"* ]]; then
            NPM_TAG="alpha"
          elif [[ "$PROVIDER_VERSION" == *"-beta"* ]]; then
            NPM_TAG="beta"
          elif [[ "$PROVIDER_VERSION" == *"-rc"* ]]; then
            NPM_TAG="rc"
          else
            NPM_TAG="latest"
          fi
          npm publish --access public --tag "$NPM_TAG"
        continue-on-error: true

      # Publish Python SDK to PyPI using Trusted Publishing (OIDC)
      # No API token needed - uses GitHub's OIDC identity
      # Automatically generates Sigstore attestations
      # See: https://docs.pypi.org/trusted-publishers/
      - name: Publish Python SDK
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: sdk/python/bin/dist/
          skip-existing: true  # Don't fail if version exists
        continue-on-error: true

      # Publish .NET SDK to NuGet using Trusted Publishing (OIDC)
      # No long-lived API key needed - uses GitHub's OIDC identity
      # See: https://learn.microsoft.com/en-us/nuget/nuget-org/trusted-publishing
      - name: NuGet Login (OIDC)
        uses: nuget/login@v1
        id: nuget-login
        with:
          user: ${{ secrets.NUGET_USERNAME }}
        continue-on-error: true

      - name: Publish .NET SDK
        if: steps.nuget-login.outcome == 'success'
        run: |
          cd sdk/dotnet
          dotnet nuget push $(find . -maxdepth 5 -name '*.nupkg' -print) --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
        continue-on-error: true

  publish_java_sdk:
    runs-on: ubuntu-latest
    needs: publish
    name: publish_java_sdk
    continue-on-error: true
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          lfs: true

      - id: version
        name: Set Provider Version
        uses: pulumi/provider-version-action@v1
        with:
          set-env: PROVIDER_VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Tools
        uses: ./.github/actions/setup-tools
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download java SDK
        uses: actions/download-artifact@v4
        with:
          name: java-sdk.tar.gz
          path: ${{ github.workspace }}/sdk/

      - name: Uncompress java SDK
        run: tar -zxf ${{ github.workspace }}/sdk/java.tar.gz -C ${{ github.workspace }}/sdk/java

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
        with:
          gradle-version: "7.6"

      # Publish to Maven Central using gradle-nexus-publish-plugin v2.0.0
      # Tasks must be in same invocation: publishToSonatype followed by closeAndReleaseSonatypeStagingRepository
      # See: https://github.com/gradle-nexus/publish-plugin
      - name: Publish Java SDK
        run: gradle -p sdk/java publishToSonatype closeAndReleaseSonatypeStagingRepository
        env:
          PACKAGE_VERSION: ${{ env.PROVIDER_VERSION }}
          SIGNING_KEY_ID: ${{ secrets.JAVA_SIGNING_KEY_ID }}
          SIGNING_KEY: ${{ secrets.JAVA_SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.JAVA_SIGNING_PASSWORD }}
          # Maven Central Portal credentials (token-based auth)
          PUBLISH_REPO_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          PUBLISH_REPO_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}

  publish_go_sdk:
    runs-on: ubuntu-latest
    needs: publish_sdks
    name: publish_go_sdk
    permissions:
      contents: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          lfs: true

      - id: version
        name: Set Provider Version
        uses: pulumi/provider-version-action@v1
        with:
          set-env: PROVIDER_VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download go SDK
        uses: actions/download-artifact@v4
        with:
          name: go-sdk.tar.gz
          path: ${{ github.workspace }}/sdk/

      - name: Uncompress go SDK
        run: tar -zxf ${{ github.workspace }}/sdk/go.tar.gz -C ${{ github.workspace }}/sdk/go

      - name: Publish Go SDK
        uses: pulumi/publish-go-sdk-action@v1
        with:
          repository: ${{ github.repository }}
          base-ref: ${{ github.sha }}
          source: sdk/go/webflow
          path: sdk/go/webflow
          version: ${{ steps.version.outputs.version }}
          additive: false
          files: "**"
